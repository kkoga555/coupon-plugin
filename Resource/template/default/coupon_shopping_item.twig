{#
 This file is part of the Coupon plugin

 Copyright(c) EC-CUBE CO.,LTD. All Rights Reserved.
 http://www.ec-cube.co.jp/

 For the full copyright and license information, please view the LICENSE
 file that was distributed with this source code.
#}
<script type="text/javascript">
    $(function () {
        $('#coupon_button').on("click", function () {
            $(this).attr('disabled', 'disabled');
            $.ajax({
                type: 'POST',
                data: $('#shopping-form').serialize(),
                url: '{{ url("shopping_redirect_to") }}',
                success: function(data) {
                    window.location.href = '{{ url('plugin_coupon_shopping') }}';
                },
                error: function() {
                    window.location.href = '{{ url('plugin_coupon_shopping') }}';
                }
            });
            return false;
        });

        // append to layout
        $(".ec-orderConfirm").last().before($("#coupon").detach());
    })

    function couponCopyToClipboard(index) {
        // クーポンコード要素の取得
        var couponCode = document.getElementById("couponCode"+index);

        //rangeオブジェクトの作成
        var range = document.createRange();
        
        // 取得したクーポンコードの内側を範囲とする
        range.selectNodeContents(couponCode);
        
        // 範囲を選択状態にする
        window.getSelection().addRange(range);

        // 選択しているテキストをクリップボードにコピーする
        document.execCommand("Copy");

        // 選択範囲をクリアする
        window.getSelection().removeRange(range);

        // ボタンのテキストを変更する
        document.getElementById("couponCopyButton"+index).value="コピーしました";
    }
</script>

<div id="coupon" class="ec-orderCoupon">
    <div class="ec-rectHeading">
        <h2>{{ 'plugin_coupon.front.shopping.header'|trans }}</h2>
    </div>
    <div id="customer_detail_box" class="column">
        {% if CouponOrder %}
            <strong class="text-danger">{{ 'plugin_coupon.front.shopping.message.use_code'|trans({'%code%': CouponOrder.coupon_cd }) }}</strong>
        {% else %}
            {{ 'plugin_coupon.front.shopping.message.empty'|trans }}
            {% if userOrderCoupon %}
                {% for item in userOrderCoupon %}
                    <p style="color:chocolate; font-weight:bold; margin-top:10px;margin-bottom: 10px;">
                        ご利用可能なクーポンコード <span id="couponCode{{ loop.index }}">{{ item.coupon_cd }}</span> （{{ item.coupon_name }}）
                        <input type="button" id="couponCopyButton{{ loop.index }}" class="btn btn-default btn-sm" value="コピーする" onclick="couponCopyToClipboard({{ loop.index }})">
                    </p>
                {% endfor %}
            {% endif %}
        {% endif %}
        <p><a class="btn btn-default btn-sm" id="coupon_button" href="{{ url('plugin_coupon_shopping') }}">{{ 'plugin_coupon.front.shopping.button.add_coupon'|trans }}</a></p>
    </div>
</div>
